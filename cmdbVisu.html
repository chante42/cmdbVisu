 <html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.3.js"></script> 
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/pdfmake-0.1.27/dt-1.10.15/b-1.4.0/b-html5-1.4.0/b-print-1.4.0/cr-1.3.3/fc-3.2.2/fh-3.1.2/kt-2.3.0/datatables.min.css"/>
 
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/pdfmake-0.1.27/dt-1.10.15/b-1.4.0/b-html5-1.4.0/b-print-1.4.0/cr-1.3.3/fc-3.2.2/fh-3.1.2/kt-2.3.0/datatables.min.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.4.1/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.4.1/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.4.1/js/buttons.print.min.js"></script>

    <link rel="stylesheet" type="text/css" href="cmdbVisu.css"/>
  
 
    <script>
        var DateFile = null;
        var DataJson = null;
        // permet de faire une recherche dans les DataJson et non seulement dans les colonnes affichées
        var ExtendSearch = false;
        ExtendSearch = true;
        //
        // getObjects
        //
		//return an array of objects according to key, value, or key and value matching
		function getObjects(obj, key, val) {
		    var objects = [];
		    for (var i in obj) {
		    	console.log(" getObjects : "+i +" val : "+obj[i]);
		        if (!obj.hasOwnProperty(i)) continue;
		        if (typeof obj[i] == 'object') {
		            objects = objects.concat(getObjects(obj[i], key, val));    
		        } 
		        //if key matches and value matches or if key matches and value is not passed (eliminating the case where key matches but passed value does not)
		        if (i == key && obj[i] == val || i == key && val == '') { //
		            objects.push(obj);
		        } else if (obj[i] == val && key == ''){
		            //only add if the object is not already in the array
		            if (objects.lastIndexOf(obj) == -1){
		                objects.push(obj);
		            }
		        }
		    }
		    return objects;
		}

		//
        // getValues
        //    
		//return an array of values that match on a certain value of hash
		// https://gist.github.com/iwek/3924925		
		// getvalues(DataJson.data[1],'a)'
		function getValues(obj, val) {
		    var objects = [];
		    var re = new RegExp(val);

		    for (var i in obj) {
		        if (!obj.hasOwnProperty(i)) continue;
		        if (typeof obj[i] == 'object') {
		            objects = objects.concat(getKeys(obj[i], val));
		        } else if (re.test(obj[i])) {
		            objects.push(obj[i]);
		        }
		    }
		    return objects;
		}


        //
        // getDataFileDisplay
        //
        // recupère la bonne string dans le tabelau de hash DateFile en fct des paramètre passé
        function getDataFileDisplay(type, field) {

            var tab_jour=new Array("Dim", "Lun", "Mar", "Mer", "Jeu", "Ven", "Sam");
            rep = ""
            match = 0
            for (item in DateFile['data']) {
                //console.log(DateFile['data'][item]['type']);
                if (DateFile['data'][item]['type'].search(type) != -1) {
                    if (match > 0) {rep += ', ';}
                    var tmp = DateFile['data'][item][field];
                    tmp = tmp.substr(0,10);
                    d = new Date(tmp);
                    console.log("tmp :"+tmp);
                    console.log("d :"+d);
                    rep = rep + tab_jour[d.getDay()] +" "+tmp;
                    match ++;
                }
            }
            if (rep == "") {
                rep = "N/A";
            }
            console.log(rep);
            return rep;
        }

        //
        // formatBaie
        //
        function formatBaie(inputWords) {        
            str = inputWords;
            a = inputWords.split(',');
            result = { };
            
            for (var i=0;  i <a.length; i++ ){
                //console.log("Boucle=|"+i+"|"+a[i]);
                if (result[a[i]] == undefined ) {
                    result[a[i]] = 1;
                }else {
                    result[a[i]] =result[a[i]] +1;
                }
            }

            var resultStr ="";
            for (var baie in result) {
               // console.log(baie);
               resultStr= resultStr + baie +":"+result[baie]+", ";
            }
            return(resultStr);
        }

        //
        /* Formatting function for row details - modify as you need */
        //
        function format ( d ) {
            var count = {};
            var storageCount = storageHDSCount = "N/A";
            class3PAR = classHDS = classVirtu = classVeeam = classTSM = classDiscovery = "normal";
            classSupervision   = classNetscaler  ="pas-d-info";
            if  (d.storage != undefined) {
                //var tmp = d.storage.split(',').forEach(function(i) { count[i] = (count[i]||0)+1;  });
                storageCount = formatBaie(d.storage);
            }else {
                class3PAR = "pas-d-info";
            }
            
            if  (d.storage_HDS != undefined) {
                //var tmp = d.storage_HDS.split(',').forEach(function(i) { count[i] = (count[i]||0)+1;  });
                storageHDSCount = formatBaie(d.storage_HDS);
            }
            else {
                classHDS = "pas-d-info";
            }
            
            if  (d.vmCpu == undefined) {
                classVirtu ="pas-d-info";
            }

            if  (d.VeeamScheduleStatus == undefined) {
                classVeeam = "pas-d-info";
            }else {
                classVeaam = "sauvegarde-OK";
            }

            if  (d.TSMStatus == undefined) {
                classTSM = "pas-d-info";
            }else {
                classTSM = "sauvegarde-OK";
            }
            if  (d.RAM == undefined) {
                classDiscovery ="pas-d-info";
            }

            vmCpu               = d.vmCpu;
            vmMem               = d.vmMem;
            vmDisk              = d.vmDisk;
            vmOs                = d.vmOs;
            allocated           = d.allocated;
            used                = d.used;
            allocated_HDS       = d.allocated_HDS;
            used_HDS            = d.used_HDS;
            VeeamScheduleStatus = d.VeeamScheduleStatus;
            VeeamFin            = d.VeeamFin;
            VeeamDure           = d.VeeamDure
            TSMDebut            = d.TSMDebut
            TSMStatus           = d.TSMStatus
            TSMFin              = d.TSMFin 
            discoveryRAM        = d.RAM 
            dicoveryNbProc      = d.PROCESSOR_COUNT
            discoveryProcessor  = d.Processeur
            discoveryFrequence  = d.Frequence

            if (d.vmCpu                         == undefined) { vmCpu                   = "N/A"} 
            if (d.vmMem                         == undefined) { vmMem                   = "N/A"}
            if (d.vmDisk                        == undefined) { vmDisk                  = "N/A"}
            if (d.vmOs                          == undefined) { vmOs                    = "N/A"}
            if (d.allocated                     == undefined) { allocated               = "N/A"}
            if (d.used                          == undefined) { used                    = "N/A"}
            if (d.allocated_HDS                 == undefined) { allocated_HDS           = "N/A"}
            if (d.used_HDS                      == undefined) { used_HDS                = "N/A"}
            if (d.VeeamScheduleStatus           == undefined) { VeeamScheduleStatus     = "N/A"}
            if (d.VeeamFin                      == undefined) { VeeamFin                = "N/A"}
            if (d.VeeamDure                     == undefined) { VeeamDure               = "N/A"}
            if (d.TSMDebut                      == undefined) { TSMDebut                = "N/A"}
            if (d.TSMFin                        == undefined) { TSMFin                  = "N/A"}
            if (d.TSMStatus                     == undefined) { TSMStatus               = "N/A"}
            if (d.RAM                           == undefined) { discoveryRAM            = "N/A"}
            if (d.PROCESSOR_COUNT               == undefined) { dicoveryNbProc          = "N/A"}
            if (d.Processeur                    == undefined) { discoveryProcessor      = "N/A"}
            if (d.Frequence                     == undefined) { discoveryFrequence      = "N/A"}

            VeeamDure           = VeeamDure.replace(':', 'h',1);
            VeeamDure           = VeeamDure.replace(':', 'm',1);
            VeeamDure           = VeeamDure + 's';
 
            // `d` is the original data object for the row
            return '<table class="detail-info" cellspacing="0" border="0" >'+
                '<tr style="background-color: #adc9f7">'+
                    '<td width="10%">'+
                        '<table cellspacing="0" border="1" >'+
                            '<tr><th>'+
                                '<div  class ="bulle"><a href="#"> Virtualisation<span>'+
                                    'la date de génération des données est le '+getDataFileDisplay('VmWare', 'date')+
                                '</span></a></div>'+
                            '</th></tr>'+
                            '<tr><td class="'+classVirtu+'"> CPU : '+vmCpu+'</td></tr>'+
                            '<tr><td class="'+classVirtu+'"> MEM : '+vmMem+' Go </td></tr>'+
                            '<tr><td class="'+classVirtu+'"> Disk : '+vmDisk+' Go</td></tr>'+
                            '<tr><td class="'+classVirtu+'"> OS :'+vmOs+'</td></tr>'+
                        '</table>'+
                    '</td>'+
                    '<td width="10%">'+
                        '<table cellspacing="0" border="1" >'+
                            '<tr><th>'+
                                '<div  class ="bulle"><a href="#"> SAN 3PAR<span>'+
                                    'la date de génération des données est le '+getDataFileDisplay('400', 'date')+
                                '</span></a></div>'+
                            '</th></tr>'+
                            '<tr><td class="'+class3PAR+'">'+storageCount+'</td></tr>'+
                            '<tr><td class="'+class3PAR+'"> alloué :'+allocated+' Go</td></tr>'+
                            '<tr><td class="'+class3PAR+'"> utilisé :'+used+' Go</td></tr>'+
                            '<tr><td class="'+class3PAR+'"> </td></tr>'+
                        '</table>'+ 
                    '</td>'+
                    '<td width="10%">'+
                        '<table cellspacing="0" border="1" >'+
                            '<tr><th>'+
                                '<div  class ="bulle"><a href="#"> SAN HDS<span>'+
                                    'la date de génération des données est le '+getDataFileDisplay('HDS', 'date')+
                                '</span></a></div>'+
                            '</th></tr>'+
                            '<tr><td class="'+classHDS+'">'+storageHDSCount+'</td></tr>'+
                            '<tr><td class="'+classHDS+'">alloué :'+allocated_HDS+' Go</td></tr>'+
                            '<tr><td class="'+classHDS+'">utilisé : '+used_HDS+' Go</td></tr>'+
                            '<tr><td class="'+classHDS+'"> </td></tr>'+
                        '</table>'+
                    '</td>'+
                    '<td width="10%">'+
                        '<table cellspacing="0" border="1" >'+
                            '<tr><th>'+
                                '<div  class ="bulle"><a href="#">Sauvegarde VEEAM<span>'+
                                'la date de génération des données est le '+getDataFileDisplay('Veeam', 'date')+
                                '</span></a></div>'+
                            '</th></tr>'+
                            '<tr><td class="'+classVeeam+'"> status : '+VeeamScheduleStatus+'</td></tr>'+
                            '<tr><td class="'+classVeeam+'"> Fin : '+VeeamFin+'</td></tr>'+
                            '<tr><td class="'+classVeeam+'"> durée : '+VeeamDure+'</td></tr>'+
                            '<tr><td class="'+classVeeam+'"> </td></tr>'+
                            '<tr><td class="'+classVeeam+'"> </td></tr>'+
                        '</table>'+
                    '</td>'+
                    '<td width="10%">'+ 
                        '<table cellspacing="0" border="1" >'+
                            '<tr><th>'+
                                '<div  class ="bulle"><a href="#"> Sauvegarde TSM<span>'+
                                'la date de génération des données est le '+getDataFileDisplay('TSM', 'date')+
                                '</span></a></div>'+
                            '</th></tr>'+
                            '<tr><td class="'+classTSM+'"> status : '+TSMStatus+'</td></tr>'+
                            '<tr><td class="'+classTSM+'"> début : '+TSMDebut+'</td></tr>'+
                            '<tr><td class="'+classTSM+'"> fin : '+TSMFin+'</td></tr>'+
                            '<tr><td class="'+classTSM+'"> </td></tr>'+
                        '</table>'+
                    '</td>'+
                    '<td width="10%">'+
                        '<table cellspacing="0" border="1" >'+
                            '<tr><th><div  class ="bulle"><a href="#">Supervision<span>le fichier source "fic" date du "date"</span></a></div></th></tr>'+
                            '<tr><td class="'+classSupervision+'"> attente Web Service O lachéré</td></tr>'+
                            '<tr><td class="'+classSupervision+'"> </td></tr>'+
                            '<tr><td class="'+classSupervision+'"> </td></tr>'+
                            '<tr><td class="'+classSupervision+'"> </td></tr>'+
                        '</table>'+
                    '</td>'+
                    '<td width="10%">'+
                        '<table cellspacing="0" border="1" >'+
                            '<tr><th><div  class ="bulle"><a href="#">Netscaler<span>le fichier source "fic" date du "date"</span></div></th></tr>'+
                            '<tr><td class="'+classNetscaler+'"> attente Netscaler</td></tr>'+
                            '<tr><td class="'+classNetscaler+'"> </td></tr>'+
                            '<tr><td class="'+classNetscaler+'"> </td></tr>'+
                            '<tr><td class="'+classNetscaler+'"> </td></tr>'+
                        '</table>'+
                    '</td>'+
                    '<td width="10%">'+
                        '<table cellspacing="0" border="1" >'+
                            '<tr><th>'+
                                '<div  class ="bulle"><a href="#">DISCOVERY<span>'+
                                'la date de génération des données est le '+getDataFileDisplay('Discovery', 'date')+
                                '<span></a></div>'+
                            '</th></tr>'+
                            '<tr><td class="'+classDiscovery+'">RAM : '+discoveryRAM+' Mo</td></tr>'+
                            '<tr><td class="'+classDiscovery+'">NbProc :'+dicoveryNbProc+' </td></tr>'+
                            '<tr><td class="'+classDiscovery+'">Proc Type :'+discoveryProcessor+' </td></tr>'+
                            '<tr><td class="'+classDiscovery+'">Proc Freq :'+discoveryFrequence+' Mhz </td></tr>'+
                        '</table>'+
                    '</td>'+
                '</tr>'+
            '</table>';
        }

        $(document).ready(function() {
            var printCounter = 0;

           // Append a caption to the table before the DataTables initialisation
           //$('#example').append('<caption style="caption-side: bottom">DSI/DPI/CSI/ Socle Infra : O chanteloup 11/09/2017.</caption>');
 
            var table = $('#example').DataTable( {
                //"ajax": "../data/result.json",
                "ajax": "data/dataTable.json",
                "columns": [
                    {
                        "className":      'details-control',
                        "orderable":      false,
                        "data":           null,
                        "defaultContent": ''
                    },
                    { "data": "Nom" },
                    { "data": "CINom" },
                    { "data": "CIResponsable" },
                    { "data": "CIImpactantResponsable" }
                ],
                 "order": [[1, 'asc']],
                lengthMenu: [[17, 25, 50, -1], [17, 25, 50, "All"]],
                keys : true,
                colReorder: true,
                dom: 'Blfrtip',

                "search": {
                     "regex": true,
                     "smart": false
                },
                buttons: [
                    {
                        extend: 'copy',
                        text: '<u>C</u>opy',
                        key: {
                            key: 'c',
                            altKey: true
                        }
                    },              
                    {
                        extend: 'excel',
                        messageTop: 'information extraite de http://vli5res01/cmdb'
                    },
                    {
                        extend: 'pdf',
                        messageBottom: null
                    },
                    {
                        extend: 'print',
                        messageTop: function () {
                            printCounter++;
         
                            if ( printCounter === 1 ) {
                                return 'This is the first time you have printed this document.';
                            }
                            else {
                                return 'You have printed this document '+printCounter+' times';
                            }
                        },
                        messageBottom: null
                    }  // fin PRINT
                ], // fin BUTTON
                initComplete: function () {  
                    this.api().columns().every( function () {  
                        var column = this;  
                        var select = $('<select><option value=""></option></select>')  
                            .appendTo( $(column.footer()).empty() )  
                            .on( 'change', function () {  
                                var val = $.fn.dataTable.util.escapeRegex(  
                                    $(this).val()  
                                );  
                        //to select and search from grid  
                                column  
                                    .search( val ? '^'+val+'$' : '', true, false )  
                                    .draw();  
                            } );  
           
                        column.data().unique().sort().each( function ( d, j ) {  
                            select.append( '<option value="'+d+'">'+d+'</option>' )  
                        } );  
                    } );

                } // fin de initcomplete 
            } ); // fin table variable 

            table.buttons().container()
                .appendTo( $('.col-sm-6:eq(0)', table.table().container() ) );
             
            // Add event listener for opening and closing details
            $('#example tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row( tr );
         
                if ( row.child.isShown() ) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child( format(row.data()) ).show();
                    tr.addClass('shown');
                }
            } ); // FIN Add event listener for opening and closing details

            // fin de lecture du json
            table.on( 'xhr', function () {
    			DataJson = table.ajax.json();
    			
			} );


			//$(function () {
			//    $('.dataTables_wrapper table').dataTable().fnFilterOnReturn();
			//});

			// tentative de recherche sur le json complet et pas seulement sur les info affiché directement par datatable
//         $.fn.dataTable.ext.search.push(
//         	
//		    function( settings, data, dataIndex, rowData, counter ) {
//		    	if (ExtendSearch != true) {
//		    		return true;
//		    	}


//		    	var searchData = $('.dataTables_filter input').val().toLowerCase();
//		        console.log(searchData);
//		        //console.log(DataJson.data[dataIndex].CIResponsable);
//		        if (getValues(DataJson.data[dataIndex], searchData) == []) {
//		        	console.log(searchData+"not Found");
//		        	return false;
//         		} else {
//         			//console.log(searchData+"Found !!!!");
//         			return true;
//         		}
//		    }
//		);
            // récupère les date de fichier pour les info Bulle
            $.getJSON("data/fileDate.json", function(data) {
                DateFile = data;
                console.log(data)
            });
        
        } ); // FIN Document Ready
    </script>
</head> 
<body>
    <div id="menu">
        <div id="gauche"><a href ="cmdbVisu-info.html" target="_blank"><img src="images/info.png" height="37" width="37"></a></div>
        <div id="droite"><a href="data/cmdbVisu.xlsx"><img src="images/excel.png">export full</a></div>
        <div id="centre"><h1>CMDB : Liste des assets et des serveurs (assynchrone) </h1></div>
    </div>  
   <div id="main"> 
        

    
        <table id="example" class="row-border cell-border hover display compact" cellspacing="0" width="100%">

           <thead>
             <tr>
                    <th></th>
                    <th>Serveur (Nom) </th>
                    <th>Application(CINom)</th>
                    <th>Responsable Appli (CIResponsable)</th>
                    <th>Responsable serveur (CIImpactantResponsable)</th>
             </tr>
            </thead>
            <tfoot>
               <tr>
                    <th></th>
                    <th>Serveur (Nom) </th>
                    <th>Application(CINom)</th>
                    <th>Responsable Appli (CIResponsable)</th>
                    <th>Responsable serveur (CIImpactantResponsable)</th>
                    
                </tr>
            </tfoot>
        </table>

        
    </div>
    <div id="footer" >@Olivier Chanteloup 17/09/2017</div>

</body>
</html>