 <html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.3.js"></script> 
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/pdfmake-0.1.27/dt-1.10.15/b-1.4.0/b-html5-1.4.0/b-print-1.4.0/cr-1.3.3/fc-3.2.2/fh-3.1.2/kt-2.3.0/datatables.min.css"/>
 
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/pdfmake-0.1.27/dt-1.10.15/b-1.4.0/b-html5-1.4.0/b-print-1.4.0/cr-1.3.3/fc-3.2.2/fh-3.1.2/kt-2.3.0/datatables.min.js"></script>

    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.4.1/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.4.1/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.4.1/js/buttons.print.min.js"></script>

    <link rel="stylesheet" type="text/css" href="cmdbVisu.css"/>
  
    <script type="text/javascript" src="cmdbVisu.js"></script> 
    <script>
        var DateFile = null;
        var DataJson = null;
        // permet de faire une recherche dans les DataJson et non seulement dans les colonnes affichées
        var ExtendSearch = false;
        ExtendSearch = true;

        $(document).ready(function() {
            var printCounter = 0;

           // Append a caption to the table before the DataTables initialisation
           //$('#example').append('<caption style="caption-side: bottom">DSI/DPI/CSI/ Socle Infra : O chanteloup 11/09/2017.</caption>');
 
            var table = $('#example').DataTable( {
                //"ajax": "../data/result.json",
                "ajax": "data/dataTable.json",
                "columns": [
                    {
                        "className":      'details-control',
                        "orderable":      false,
                        "data":           null,
                        "defaultContent": ''
                    },
                    { "data": "Nom" },
                    { "data": "CINom" },
                    { "data": "CIResponsable" },
                    { "data": "CIImpactantResponsable" }
                ],
                 "order": [[1, 'asc']],
                lengthMenu: [[17, 25, 50, -1], [17, 25, 50, "All"]],
                keys : true,
                colReorder: true,
                dom: 'Blfrtip',

                "search": {
                     "regex": true,
                     "smart": false
                },
                buttons: [
                    {
                        extend: 'copy',
                        text: '<u>C</u>opy',
                        key: {
                            key: 'c',
                            altKey: true
                        }
                    },              
                    {
                        extend: 'excel',
                        messageTop: 'information extraite de http://vli5res01/cmdb'
                    },
                    {
                        extend: 'pdf',
                        messageBottom: null
                    },
                    {
                        extend: 'print',
                        messageTop: function () {
                            printCounter++;
         
                            if ( printCounter === 1 ) {
                                return 'This is the first time you have printed this document.';
                            }
                            else {
                                return 'You have printed this document '+printCounter+' times';
                            }
                        },
                        messageBottom: null
                    }  // fin PRINT
                ], // fin BUTTON
                initComplete: function () {  
                    this.api().columns().every( function () {  
                        var column = this;  
                        var select = $('<select><option value=""></option></select>')  
                            .appendTo( $(column.footer()).empty() )  
                            .on( 'change', function () {  
                                var val = $.fn.dataTable.util.escapeRegex(  
                                    $(this).val()  
                                );  
                        //to select and search from grid  
                                column  
                                    .search( val ? '^'+val+'$' : '', true, false )  
                                    .draw();  
                            } );  
           
                        column.data().unique().sort().each( function ( d, j ) {  
                            select.append( '<option value="'+d+'">'+d+'</option>' )  
                        } );  
                    } );

                } // fin de initcomplete 
            } ); // fin table variable 

            table.buttons().container()
                .appendTo( $('.col-sm-6:eq(0)', table.table().container() ) );
             
            // Add event listener for opening and closing details
            $('#example tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row( tr );
         
                if ( row.child.isShown() ) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child( format(row.data()) ).show();
                    tr.addClass('shown');
                }
            } ); // FIN Add event listener for opening and closing details

            // fin de lecture du json
            table.on( 'xhr', function () {
    			DataJson = table.ajax.json();
    			
			} );


			//$(function () {
			//    $('.dataTables_wrapper table').dataTable().fnFilterOnReturn();
			//});

			// tentative de recherche sur le json complet et pas seulement sur les info affiché directement par datatable
//         $.fn.dataTable.ext.search.push(
//         	
//		    function( settings, data, dataIndex, rowData, counter ) {
//		    	if (ExtendSearch != true) {
//		    		return true;
//		    	}


//		    	var searchData = $('.dataTables_filter input').val().toLowerCase();
//		        console.log(searchData);
//		        //console.log(DataJson.data[dataIndex].CIResponsable);
//		        if (getValues(DataJson.data[dataIndex], searchData) == []) {
//		        	console.log(searchData+"not Found");
//		        	return false;
//         		} else {
//         			//console.log(searchData+"Found !!!!");
//         			return true;
//         		}
//		    }
//		);
            // récupère les date de fichier pour les info Bulle
            $.getJSON("data/fileDate.json", function(data) {
                DateFile = data;
                console.log(data)
            });
        
        } ); // FIN Document Ready
    </script>
</head> 
<body>
    <div id="menu">
        <div id="gauche"><a href ="cmdbVisu-info.html" target="_blank"><img src="images/info.png" height="37" width="37"></a></div>
        <div id="droite"><a href="data/cmdbVisu.xlsx"><img src="images/excel.png">export full</a></div>
        <div id="centre"><h1>CMDB : Liste des assets et des serveurs (assynchrone) </h1></div>
    </div>  
   <div id="main"> 
        

    
        <table id="example" class="row-border cell-border hover display compact" cellspacing="0" width="100%">

           <thead>
             <tr>
                    <th></th>
                    <th>Serveur (Nom) </th>
                    <th>Application(CINom)</th>
                    <th>Responsable Appli (CIResponsable)</th>
                    <th>Responsable serveur (CIImpactantResponsable)</th>
             </tr>
            </thead>
            <tfoot>
               <tr>
                    <th></th>
                    <th>Serveur (Nom) </th>
                    <th>Application(CINom)</th>
                    <th>Responsable Appli (CIResponsable)</th>
                    <th>Responsable serveur (CIImpactantResponsable)</th>
                    
                </tr>
            </tfoot>
        </table>

        
    </div>
    <div id="footer" >@Olivier Chanteloup 27/09/2017</div>

</body>
</html>